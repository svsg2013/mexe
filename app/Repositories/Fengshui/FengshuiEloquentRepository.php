<?php/** * Created by PhpStorm. * User: LeThanh * Date: 10/19/2017 * Time: 9:55 PM */namespace App\Repositories\Fengshui;use App\Repositories\EloquentRepository;use App\Category;use App\ChildCate;use App\News;use App\Tag;use App\News_tag;use App\Fengshui;use App\Products;use App\NewsProduct;use Illuminate\Support\Facades\Input;use Illuminate\Support\Facades\DB;class FengshuiEloquentRepository extends EloquentRepository implements FengshuiRepositoryInterface{    public function getModel()    {        // TODO: Implement getModel() method.        return \App\Fengshui::class;    }    public function unseri($id)    {        $getPostandUn = array();        //truy vấn relation lấy giá trị để biên dịch lại mảng bị mã hóa        $getId = DB::table('fengshuis')->select('relation')->where('id', $id)->get();        //truy vấn lấy dữ liệu news        $getPost = DB::table('fengshuis')->select('id', 'title')->get();        //chọn giá trị mảng tới phần tử object        $unseri = unserialize($getId[0]->relation);        //gôm chung giá trị vào một mảng để xử lý foreach lấy giá trị relation        foreach ($getPost as $getData) {            $getPostandUn[] = array(                'id' => $getData->id,                'title' => $getData->title,                'relation' => $unseri            );        }        return $getPostandUn;    }    public function getAll()    {        $getData = Fengshui::all('id', 'title', 'hot', 'feature', 'active', 'sort', 'relation');        return $getData;    }    public function getProduct()    {        $getProduct = Products::all('id', 'title');        return $getProduct;    }    public function getTags($id = 0)    {        if ($id == 0) {            $allTags = DB::table('products')->select('id', 'title')->get()->toArray();            return $allTags;        } else {            $getTagandChek = array();            $getIDProds = DB::table('news_products')->select('id_product')->where('id_news', $id)->get()->toArray();            return $getIDProds;        }    }    public function getDataMenu()    {        $cate = DB::table('cate_tt_phongthuys')            ->leftjoin('child_tt_phongthuys', 'cate_tt_phongthuys.id', '=', 'child_tt_phongthuys.cateParen_id')            ->select('name', 'lvl', 'alias', 'metaName', 'description', 'weight', 'child_tt_phongthuys.cateParen_id')            ->get();        return $cate;    }    public function getCreateAndEdit($inputFile, $id = 0)    {        if ($id == 0) {            $news = new Fengshui();            $news->view = 1;            if (isset($inputFile['slPost'])) {                $news->relation = serialize($inputFile['slPost']);            }            if (isset($inputFile['txtName'])) {                $news->title = $inputFile['txtName'];            }            if (isset($inputFile['slMenu'])) {                $news->Cate_id = $inputFile['slMenu'];            }            if (!isset($inputFile['txtMetatitle'])) {                $news->metaTitle = $inputFile['txtName'];            } else {                $news->metaTitle = $inputFile['txtMetatitle'];            }            $news->alias = changeTitle($inputFile['txtName']);            if (isset($inputFile['txtSummary'])) {                $news->summary = $inputFile['txtSummary'];            }            if (!isset($inputFile['txtDescription'])) {                $news->description = $inputFile['txtSummary'];            } else {                $news->description = $inputFile['txtDescription'];            }            $news->content = $inputFile['txtContent'];            if (!isset($inputFile['checkHot']) && !isset($inputFile['checkFeature'])) {                $news->hot = 0;                $news->feature = 0;            } elseif (isset($inputFile['checkHot']) && !isset($inputFile['checkFeature'])) {                $news->hot = $inputFile['checkHot'];                $news->feature = 0;            } elseif (isset($inputFile['checkHot']) && isset($inputFile['checkFeature'])) {                $news->hot = $inputFile['checkHot'];                $news->feature = $inputFile['checkFeature'];            } else {                $news->hot = 0;                $news->feature = $inputFile['checkFeature'];            }            if (isset($inputFile['checkActive'])) {                $news->active = $inputFile['checkActive'];            } else {                $news->active = 0;            }            if (isset($inputFile['txtWeight'])) {                $news->sort = $inputFile['txtWeight'];            }            if (Input::hasFile('fileImg')) {                $file = Input::file('fileImg');                $name = $file->getClientOriginalName();                $file->move('upload/thumbnail', $name);                $news->images = $name;            }            $news->save();            //danh sach san pham da chon            $idNews = $news->id;            if (isset($inputFile['slProd'])) {                $getData = Input::get('slProd');                foreach ($getData as $data) {                    $newsProduct = new NewsProduct();                    $newsProduct->id_news = $idNews;                    $newsProduct->id_product = $data;                    $newsProduct->save();                }            }            return redirect()                ->route('fengshui.index')                ->with([                    'thongbao' => 'Tin được tạo thành công'                ]);        } else {            $news = $this->find($id);            $news->view = 1;            if (isset($inputFile['slPost'])) {                $news->relation = serialize($inputFile['slPost']);            }            $news->title = $inputFile['txtName'];            $news->Cate_id = $inputFile['slMenu'];            if (!isset($inputFile['txtMetatitle'])) {                $news->metaTitle = $inputFile['txtName'];            } else {                $news->metaTitle = $inputFile['txtMetatitle'];            }            $news->alias = changeTitle($inputFile['txtName']);            $news->summary = $inputFile['txtSummary'];            if (!isset($inputFile['txtDescription'])) {                $news->description = $inputFile['txtSummary'];            } else {                $news->description = $inputFile['txtDescription'];            }            $news->content = $inputFile['txtContent'];            if (!isset($inputFile['checkHot']) && !isset($inputFile['checkFeature'])) {                $news->hot = 0;                $news->feature = 0;            } elseif (isset($inputFile['checkHot']) && !isset($inputFile['checkFeature'])) {                $news->hot = $inputFile['checkHot'];                $news->feature = 0;            } elseif (isset($inputFile['checkHot']) && isset($inputFile['checkFeature'])) {                $news->hot = $inputFile['checkHot'];                $news->feature = $inputFile['checkFeature'];            } else {                $news->hot = 0;                $news->feature = $inputFile['checkFeature'];            }            if (isset($inputFile['checkActive'])) {                $news->active = $inputFile['checkActive'];            } else {                $news->active = 0;            }            if (isset($inputFile['txtWeight'])) {                $news->sort = $inputFile['txtWeight'];            }            if (Input::hasFile('fileImg')) {                $file = Input::file('fileImg');                $name = $file->getClientOriginalName();                $file->move('upload/thumbnail', $name);                $news->images = $name;            }            $news->save();            if (Input::has('slProd')) {                NewsProduct::where('id_news', $id)->delete();                $getData = Input::get('slProd');                foreach ($getData as $data) {                    $newsProduct = new NewsProduct();                    $newsProduct->id_news = $id;                    $newsProduct->id_product = $data;                    $newsProduct->save();                }            }            return redirect()                ->route('fengshui.index')                ->with([                    'thongbao' => 'Tin chỉnh sửa thành công'                ]);        }    }    public function getDelete($id)    {        $news = Fengshui::find($id);        $getDelete = Fengshui::find($id)->delete();//        DB::table('news_tags')->where('news_id', $id)->delete();//        unlink('upload/thumbnail/' . $news->images);        return redirect()->route('fengshui.index')->with(['thongbao' => 'Tin tức đã được xóa, bất ngờ chưa!!!']);    }}